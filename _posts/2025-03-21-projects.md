---
title: "PROJECTS"
date: 2025-03-21
---
DandCTestPv
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bauhaus Task Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <style>
        :root {
            --bauhaus-red: #dd1e34;
            --bauhaus-yellow: #fccf0a;
            --bauhaus-blue: #0157a2;
            --bauhaus-black: #222222;
            --bauhaus-grey: #f0f0f0;
            --bauhaus-dark-red: #a60a1d;
            --bauhaus-dark-yellow: #c4a607;
            --bauhaus-dark-blue: #003a6e;
            --text-dark: #333;
            --text-light: #555;
            --border-light: #e0e0e0;
            --background-light: #ffffff;
            --success-green: #34A853;
            --edit-blue: #3498db;
            --delete-red: #e74c3c;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bauhaus-grey);
            color: var(--text-dark);
            padding-top: 70px; /* More Space for fixed timer */
            line-height: 1.5;
        }
        .container {
            max-width: 1100px; /* Wider container */
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 30px;
        }
        .chart-section {
             flex: 3; /* Chart takes more space */
             min-width: 400px; /* Min width for chart area */
             display: flex;
             flex-direction: column;
             align-items: center;
        }
        .controls-section {
            flex: 2; /* Controls/List take less space */
             min-width: 300px;
        }

        .title {
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
            color: var(--bauhaus-blue);
        }
        .subtitle {
            font-size: 16px;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 30px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 550px; /* Slightly smaller max chart */
            margin: 0 auto 30px auto;
            aspect-ratio: 1 / 1; /* Keep it square */
        }
        .button-bar {
            text-align: center;
            margin-bottom: 25px;
        }
         .action-button-main {
            display: inline-block;
            padding: 12px 25px; /* More padding */
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            color: white;
            border: none;
            background-color: var(--bauhaus-blue);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .action-button-main:hover {
             background-color: var(--bauhaus-dark-blue);
             transform: translateY(-1px);
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-button-main:active {
             transform: translateY(0px);
        }

        /* --- Modal (Dialog) Styles --- */
        dialog {
            border: none; /* Cleaner look */
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 350px;
            max-width: 500px;
            margin: auto;
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        dialog h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 22px;
            color: var(--bauhaus-blue);
             font-weight: 600;
             text-align: center;
        }
        .dialog-actions {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
         .dialog-button {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            border: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
         }
         .dialog-button.primary { background-color: var(--success-green); color: white; }
         .dialog-button.primary:hover { background-color: #2a8c4a; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
         .dialog-button.cancel { background-color: #ccc; color: #333; }
         .dialog-button.cancel:hover { background-color: #bbb; }

        /* --- Form Input Styles (used in dialogs) --- */
         .input-group { margin-bottom: 18px; }
         .input-label {
            font-size: 14px; margin-bottom: 8px;
            color: var(--text-light); display: block; font-weight: 500;
        }
         .input {
            width: 100%; border: 1px solid var(--border-light); border-radius: 4px;
            padding: 12px; font-size: 16px; transition: border-color 0.2s ease;
         }
         .input:focus {
             border-color: var(--bauhaus-blue);
             outline: none;
             box-shadow: 0 0 0 2px rgba(1, 87, 162, 0.2);
         }

        /* --- Task List & Finished List Styles --- */
        .list-section { /* Common style for both lists */
            background-color: var(--background-light); border-radius: 8px;
            padding: 20px; margin-bottom: 30px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
         .list-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--bauhaus-black); }
         .task-list, .finished-list { margin-top: 8px; max-height: 50vh; overflow-y: auto; padding-right: 5px;} /* Scrollable lists */

         .task-item, .finished-item {
            border-bottom: 1px solid var(--border-light);
            padding: 12px 5px 12px 0; /* More padding */
            display: flex;
            flex-direction: column; /* Stack header/meta vertically */
            gap: 5px;
         }
         .task-item:last-child, .finished-item:last-child { border-bottom: none; }

         .item-header { /* Header for both task and finished item */
            display: flex; justify-content: space-between; align-items: center;
        }
         .item-title-row { display: flex; align-items: center; gap: 10px; }
         .color-indicator {
            width: 16px; height: 16px; border-radius: 3px; /* Square indicator */
            display: inline-block; flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
        }
         .item-title { font-size: 16px; font-weight: 500; }
         .task-meta { /* For deadline and add subtask button */
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: var(--text-light);
            margin-left: 26px; /* Indent meta info (indicator width + gap) */
         }
         .task-deadline { font-style: normal; } /* Remove italic */
         .add-subtask-list-btn {
            padding: 4px 10px; font-size: 12px; cursor: pointer;
            border: 1px solid var(--success-green); color: var(--success-green);
            background-color: white; border-radius: 3px; transition: background-color 0.2s ease, color 0.2s ease;
         }
        .add-subtask-list-btn:hover { background-color: #e8f5e9; }

        .item-actions { display: flex; gap: 8px; } /* Actions on the right */
        .action-button { /* Small buttons in list */
            padding: 5px 10px; border-radius: 4px;
            cursor: pointer; color: white; font-size: 12px;
            font-weight: 500; border: none;
            transition: opacity 0.2s ease;
        }
        .action-button:hover { opacity: 0.85; }
        .done-button { background-color: var(--success-green); }
        .edit-button { background-color: var(--edit-blue); }
        .delete-button { background-color: var(--delete-red); }

         .subtask-list { margin-left: 26px; margin-top: 8px; display: flex; flex-direction: column; gap: 5px;}
         .subtask-item {
            display: flex; justify-content: space-between;
            align-items: center; padding: 3px 0; font-size: 14px;
            color: var(--text-light);
        }
         .subtask-title-row { display: flex; align-items: center; gap: 8px; }
         .subtask-color-indicator {
            width: 10px; height: 10px; border-radius: 2px;
            display: inline-block; flex-shrink: 0;
             border: 1px solid rgba(0,0,0,0.05);
        }
        .finished-details { font-size: 13px; color: var(--text-light); margin-left: 26px; }

        /* --- Timer Styles --- */
         .timer-section {
            position: fixed; top: 15px; left: 15px;
            background-color: rgba(255, 255, 255, 0.95); /* Slightly less transparent */
            padding: 10px 15px; border-radius: 6px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none; /* Hidden initially */
            font-size: 14px; min-width: 220px; text-align: left;
            border: 1px solid var(--border-light);
            opacity: 0; /* Start hidden for fade-in */
            transition: opacity 0.3s ease-in-out;
        }
        .timer-section.visible {
             opacity: 1;
        }
         .timer-section h3 {
             margin: 0 0 6px 0; font-size: 13px; color: var(--text-dark); font-weight: 600;
             white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; display: inline-block;
        }
         .timer-section div {
            font-size: 2em; color: var(--bauhaus-red);
            font-weight: 700; margin-bottom: 3px; display: block;
        }
         .timer-section button { /* Tiny cancel button */
            padding: 3px 7px; font-size: 11px; margin-left: 8px; cursor: pointer;
            border: 1px solid var(--delete-red); background: #fff; color: var(--delete-red); border-radius: 3px;
             vertical-align: middle; /* Align with text */
         }
         .timer-controls { display: flex; justify-content: space-between; align-items: center;}


        /* Utility */
         .hidden { display: none; }
        .text-danger { color: var(--bauhaus-red); font-weight: 500;}
        .text-warning { color: var(--bauhaus-yellow); font-weight: 500;}
        .text-muted { color: var(--text-light); }

         /* Scrollbar styling (optional) */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px;}
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px;}
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

    </style>
</head>
<body>
    <div class="timer-section" id="timerDisplaySection">
        <div class="timer-controls">
            <h3 id="timerTaskName">Timing Task</h3>
            <button id="cancelTimerBtn" title="Cancel Timer">✖</button>
        </div>
        <div id="timerCountdown">00:00</div>
    </div>

    <div class="container">

        <div class="chart-section">
            <h1 class="title">Bauhaus Task Dashboard</h1>
            <p class="subtitle">Visualize task distribution and deadlines</p>
            <div class="button-bar">
                 <button id="showAddTaskModalBtn" class="action-button-main">Add New Task</button>
            </div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="controls-section">
            <div class="list-section">
                <h2 class="list-title">Active Tasks</h2>
                <div class="task-list" id="taskList">
                    {/* Tasks will be dynamically inserted here */}
                </div>
            </div>

            {/* Recently Finished Section */}
            <div class="list-section">
                <h2 class="list-title">Recently Finished (Last 7 Days)</h2>
                 <div class="finished-list" id="finishedList">
                     {/* Finished tasks will be dynamically inserted here */}
                </div>
            </div>
        </div>
    </div>

    <dialog id="addTaskDialog">
        <h2>Add New Task</h2>
        <form id="addTaskForm" method="dialog"> {/* Use method="dialog" for easier closing */}
            <div class="input-group">
                <label class="input-label" for="taskName">Task Name</label>
                <input class="input" id="taskName" type="text" required>
            </div>
            <div class="input-group">
                <label class="input-label" for="taskValue">Estimated Time (Minutes)</label>
                <input class="input" id="taskValue" type="number" min="1" required>
            </div>
             <div class="input-group">
                <label class="input-label" for="taskDeadline">Deadline (Optional)</label>
                <input class="input" id="taskDeadline" type="date">
            </div>
            <div class="dialog-actions">
                 <button type="button" class="dialog-button cancel" value="cancel">Cancel</button>
                 <button type="submit" class="dialog-button primary" value="add">Add Task</button>
            </div>
        </form>
    </dialog>

    <dialog id="addSubtaskDialog">
        <h2 id="addSubtaskTitle">Add Subtask</h2>
        <form id="addSubtaskForm" method="dialog">
             <input type="hidden" id="parentTaskId">
            <div class="input-group">
                <label class="input-label" for="subtaskName">Subtask Name</label>
                <input class="input" id="subtaskName" type="text" required>
            </div>
            <div class="input-group">
                <label class="input-label" for="subtaskValue">Estimated Time (Minutes)</label>
                <input class="input" id="subtaskValue" type="number" min="1" required>
            </div>
            <div class="dialog-actions">
                 <button type="button" class="dialog-button cancel" value="cancel">Cancel</button>
                 <button type="submit" class="dialog-button primary" value="add">Add Subtask</button>
            </div>
        </form>
    </dialog>

    <dialog id="editTaskDialog">
        <h2>Edit Task</h2>
        <form id="editTaskForm" method="dialog">
            <input type="hidden" id="editTaskId">
            <div class="input-group">
                <label class="input-label" for="editTaskName">Task Name</label>
                <input class="input" id="editTaskName" type="text" required>
            </div>
            <div class="input-group">
                <label class="input-label" for="editTaskValue">Estimated Time (Minutes)</label>
                <input class="input" id="editTaskValue" type="number" min="1" required>
            </div>
             <div class="input-group">
                <label class="input-label" for="editTaskDeadline">Deadline</label>
                <input class="input" id="editTaskDeadline" type="date">
            </div>
            <div class="dialog-actions">
                 <button type="button" class="dialog-button cancel" value="cancel">Cancel</button>
                 <button type="submit" class="dialog-button primary" value="update">Update Task</button>
            </div>
        </form>
    </dialog>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global Variables & Constants ---
            let tasks = [];
            let mainChart = null;
            let currentTimerInterval = null;
            let currentTimerInfo = { id: null, type: null }; // Store ID and type (task/subtask) of timed item

            const BAUHAUS_PALETTE = ['#dd1e34', '#fccf0a', '#0157a2', '#222222', '#f0f0f0'];
            const BAUHAUS_DARK = ['#a60a1d', '#c4a607', '#003a6e', '#000000', '#cccccc'];
            const TODAY = new Date();
            TODAY.setHours(0, 0, 0, 0); // Normalize

            // --- DOM Elements ---
            const taskList = document.getElementById('taskList');
            const finishedList = document.getElementById('finishedList');
            // Timer
            const timerDisplaySection = document.getElementById('timerDisplaySection');
            const timerTaskName = document.getElementById('timerTaskName');
            const timerCountdown = document.getElementById('timerCountdown');
            const cancelTimerBtn = document.getElementById('cancelTimerBtn');
            // Dialogs
            const addTaskDialog = document.getElementById('addTaskDialog');
            const addSubtaskDialog = document.getElementById('addSubtaskDialog');
            const editTaskDialog = document.getElementById('editTaskDialog');
            // Forms & Inputs
            const addTaskForm = document.getElementById('addTaskForm');
            const taskNameInput = document.getElementById('taskName');
            const taskValueInput = document.getElementById('taskValue');
            const taskDeadlineInput = document.getElementById('taskDeadline');
            const addSubtaskForm = document.getElementById('addSubtaskForm');
            const subtaskNameInput = document.getElementById('subtaskName');
            const subtaskValueInput = document.getElementById('subtaskValue');
            const parentTaskIdInput = document.getElementById('parentTaskId');
            const addSubtaskTitle = document.getElementById('addSubtaskTitle');
            const editTaskForm = document.getElementById('editTaskForm');
            const editTaskIdInput = document.getElementById('editTaskId');
            const editTaskNameInput = document.getElementById('editTaskName');
            const editTaskValueInput = document.getElementById('editTaskValue');
            const editTaskDeadlineInput = document.getElementById('editTaskDeadline');
            // Trigger Buttons
            const showAddTaskModalBtn = document.getElementById('showAddTaskModalBtn');

            // --- Color & Deadline Logic ---
            function darkenColor(hex, percent) {
               hex = hex.replace('#', '');
               let r = parseInt(hex.substring(0, 2), 16);
               let g = parseInt(hex.substring(2, 4), 16);
               let b = parseInt(hex.substring(4, 6), 16);
               r = Math.max(0, Math.floor(r * (1 - percent / 100)));
               g = Math.max(0, Math.floor(g * (1 - percent / 100)));
               b = Math.max(0, Math.floor(b * (1 - percent / 100)));
               return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }

            function getTaskColorInfo(task, index) {
                const baseColorIndex = index % (BAUHAUS_PALETTE.length - 1);
                let baseColor = BAUHAUS_PALETTE[baseColorIndex];
                let finalColor = baseColor;
                let darkeningPercent = 0;
                let urgency = 'normal';

                if (task.deadline) {
                    try {
                        const deadlineDate = new Date(task.deadline);
                        deadlineDate.setUTCHours(0, 0, 0, 0); // Use UTC to avoid timezone shifts affecting date comparison
                        const todayUTC = new Date(Date.UTC(TODAY.getFullYear(), TODAY.getMonth(), TODAY.getDate()));

                        // Calculate difference in days based on UTC midnight
                        const timeDiff = deadlineDate.getTime() - todayUTC.getTime();
                        const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24)); // Use floor for comparison

                         //console.log(`Task: ${task.name}, Deadline: ${task.deadline}, DeadlineUTC: ${deadlineDate.toISOString()}, TodayUTC: ${todayUTC.toISOString()}, DaysDiff: ${daysDiff}`);


                        if (daysDiff < 0) { // Overdue (deadline was yesterday or earlier)
                            darkeningPercent = 70; urgency = 'overdue';
                        } else if (daysDiff < 7) { // Due soon (today up to 6 days from now)
                            darkeningPercent = 35; urgency = 'due_soon';
                        }

                        if (darkeningPercent > 0) {
                           finalColor = darkenColor(baseColor, darkeningPercent);
                           if (darkeningPercent >= 70 && ['#fccf0a', '#f0f0f0'].includes(baseColor)) {
                               finalColor = BAUHAUS_DARK[3]; // Use dark grey/black for light overdue tasks
                           } else if (darkeningPercent >= 70) {
                               finalColor = BAUHAUS_DARK[baseColorIndex] || finalColor; // Use predefined dark shades
                           }
                        }
                    } catch (e) { console.error("Error parsing deadline date:", task.deadline, e); }
                }
                return { baseColor, finalColor, urgency };
            }

            function varyColor(hex, amount = 20) {
               hex = hex.replace('#', '');
               let r = parseInt(hex.substring(0, 2), 16);
               let g = parseInt(hex.substring(2, 4), 16);
               let b = parseInt(hex.substring(4, 6), 16);
               r = Math.min(255, r + amount);
               g = Math.min(255, g + amount);
               b = Math.min(255, b + amount);
               return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }

            // --- Timer Functions ---
             function startCountdown(itemName, durationMinutes, itemId, itemType) {
                 if (currentTimerInterval) clearInterval(currentTimerInterval);
                 currentTimerInfo = { id: itemId, type: itemType }; // Store what's being timed

                 let totalSeconds = Math.max(0, durationMinutes * 60);
                 timerTaskName.textContent = `${itemName}`;
                 timerDisplaySection.style.display = 'block';
                 // Fade in effect
                 setTimeout(() => timerDisplaySection.classList.add('visible'), 10);
                 console.log(`Starting timer for ${itemType} ${itemName} (ID: ${itemId}) - ${durationMinutes} min`);

                 currentTimerInterval = setInterval(() => {
                     if (totalSeconds <= 0) {
                         clearInterval(currentTimerInterval);
                         currentTimerInterval = null;
                         timerCountdown.textContent = "Done!";
                         alert(`Timer for "${itemName}" finished!`);
                          // Mark the item as done automatically
                          if (currentTimerInfo.id && currentTimerInfo.type) {
                             markAsDone(currentTimerInfo.id, currentTimerInfo.type);
                          }
                         currentTimerInfo = { id: null, type: null };
                         // Fade out
                         timerDisplaySection.classList.remove('visible');
                         setTimeout(() => { if (!currentTimerInterval) timerDisplaySection.style.display = 'none'; }, 300);
                         return;
                     }
                     totalSeconds--;
                     const minutes = Math.floor(totalSeconds / 60);
                     const seconds = totalSeconds % 60;
                     timerCountdown.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                 }, 1000);
             }

             cancelTimerBtn.addEventListener('click', () => {
                 if (currentTimerInterval) {
                     clearInterval(currentTimerInterval);
                     currentTimerInterval = null;
                     currentTimerInfo = { id: null, type: null };
                     timerDisplaySection.classList.remove('visible');
                     setTimeout(() => timerDisplaySection.style.display = 'none', 300);
                     alert('Timer cancelled.');
                 }
             });

            // --- Chart Click Handler ---
            function handleChartClick(clickEvent, chartInstance) {
                if (!chartInstance) return;
                const points = chartInstance.getElementsAtEventForMode(clickEvent, 'nearest', { intersect: true }, true);

                if (points.length) {
                    const firstPoint = points[0];
                    const datasetIndex = firstPoint.datasetIndex;
                    const index = firstPoint.index;
                    const chartData = chartInstance.config.data.preparedData;
                    let itemName = '';
                    let itemValue = 0;
                    let itemId = null;
                    let itemType = null; // 'task' or 'subtask'

                    if (datasetIndex === 0 && chartData.tasks[index]) { // Task
                        const taskInfo = chartData.tasks[index];
                        itemId = taskInfo.id; itemType = 'task';
                        itemName = taskInfo.name; itemValue = taskInfo.value;
                    } else if (datasetIndex === 1 && chartData.subtasks[index]) { // Subtask
                        const subtaskInfo = chartData.subtasks[index];
                         itemId = subtaskInfo.id; itemType = 'subtask';
                         itemName = subtaskInfo.name; itemValue = subtaskInfo.value;
                    }

                    if (itemName && itemValue > 0 && itemId && itemType) {
                        if (window.confirm(`Start timer for ${itemType} "${itemName}" (${itemValue} minutes)?`)) {
                            startCountdown(itemName, itemValue, itemId, itemType);
                        }
                    } else { console.warn("Could not determine item details from click."); }
                }
            }

            // --- Task & Subtask CRUD + Finish Logic ---
            function addTask(name, value, deadline) {
                tasks.push({
                    id: Date.now(), name, value, deadline: deadline || null,
                    finished: false, finishDate: null, subtasks: []
                });
                saveTasks();
                rerenderAll();
            }

            function addSubtask(parentId, name, value) {
               const task = tasks.find(t => t.id === parentId);
               if (task) {
                    const currentSubtasksTotal = task.subtasks.filter(st => !st.finished).reduce((sum, st) => sum + st.value, 0);
                    if (currentSubtasksTotal + value > task.value) {
                        alert(`Subtask value (${value}) exceeds remaining value for task "${task.name}" (${task.value - currentSubtasksTotal} remaining).`);
                        return false;
                    }
                    task.subtasks.push({ id: Date.now(), name, value, finished: false, finishDate: null });
                    saveTasks();
                    rerenderAll();
                    return true;
                } return false;
            }

            function updateTask(id, name, value, deadline) {
                const taskIndex = tasks.findIndex(t => t.id === id);
                if (taskIndex !== -1) {
                    const task = tasks[taskIndex];
                    const subtasksTotal = task.subtasks.filter(st => !st.finished).reduce((sum, st) => sum + st.value, 0);
                    if (value < subtasksTotal) {
                        alert(`Task value (${value}) cannot be less than the sum of its active subtasks (${subtasksTotal}).`);
                        return false;
                    }
                    tasks[taskIndex] = { ...task, name, value, deadline: deadline || null }; // Preserve other fields
                    saveTasks();
                    rerenderAll();
                    return true;
                } return false;
            }

            function deleteTask(taskId) {
                tasks = tasks.filter(task => task.id !== taskId);
                saveTasks();
                rerenderAll();
            }

            function deleteSubtask(taskId, subtaskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
                    saveTasks();
                    rerenderAll();
                }
            }

            // New function to mark item as done
             function markAsDone(itemId, itemType) {
                let itemFound = false;
                if (itemType === 'task') {
                     const task = tasks.find(t => t.id === itemId);
                     if (task && !task.finished) {
                         task.finished = true;
                         task.finishDate = new Date().toISOString();
                         // Optionally mark all subtasks as done too? Or leave them? Let's leave them for now.
                         itemFound = true;
                         console.log(`Task "${task.name}" marked as done.`);
                     }
                } else if (itemType === 'subtask') {
                     tasks.forEach(task => {
                         const subtask = task.subtasks.find(st => st.id === itemId);
                         if (subtask && !subtask.finished) {
                             subtask.finished = true;
                             subtask.finishDate = new Date().toISOString();
                             itemFound = true;
                             console.log(`Subtask "${subtask.name}" marked as done.`);
                         }
                     });
                }

                if (itemFound) {
                     saveTasks();
                     rerenderAll(); // Rerender lists and update chart
                 }
             }

            // --- Persistence ---
            function saveTasks() {
                localStorage.setItem('bauhausTaskData_v2', JSON.stringify(tasks));
            }

            function loadTasks() {
                const savedTasks = localStorage.getItem('bauhausTaskData_v2');
                // Basic structure validation (check if it's an array)
                try {
                     const parsed = savedTasks ? JSON.parse(savedTasks) : null;
                     tasks = Array.isArray(parsed) ? parsed : createDefaultTasks();
                } catch {
                     tasks = createDefaultTasks();
                }
                // Ensure all tasks/subtasks have the new properties
                tasks.forEach(task => {
                     task.finished = task.finished ?? false;
                     task.finishDate = task.finishDate ?? null;
                     task.subtasks = task.subtasks ?? [];
                     task.subtasks.forEach(subtask => {
                          subtask.finished = subtask.finished ?? false;
                          subtask.finishDate = subtask.finishDate ?? null;
                     });
                });
                rerenderAll();
            }

            function createDefaultTasks() {
                // Get dates relative to today for dynamic deadlines
                 const tomorrow = new Date(TODAY); tomorrow.setDate(TODAY.getDate() + 1);
                 const nextWeek = new Date(TODAY); nextWeek.setDate(TODAY.getDate() + 7);
                 const twoWeeks = new Date(TODAY); twoWeeks.setDate(TODAY.getDate() + 14);
                 const formatDate = (date) => date.toISOString().split('T')[0]; // YYYY-MM-DD format

                return [
                    {id: 1, name: "Urgent: Bauhaus Poster", value: 120, deadline: formatDate(tomorrow), finished: false, finishDate: null, subtasks: [
                        {id: 11, name: "Grid Layout", value: 45, finished: false, finishDate: null}, {id: 12, name: "Typography", value: 45, finished: false, finishDate: null}, {id: 13, name: "Color Blocks", value: 30, finished: false, finishDate: null}
                    ]},
                    {id: 2, name: "Website Mockup", value: 240, deadline: formatDate(nextWeek), finished: false, finishDate: null, subtasks: [
                        {id: 21, name: "Homepage Design", value: 120, finished: false, finishDate: null}, {id: 22, name: "About Page", value: 60, finished: false, finishDate: null}, {id: 23, name: "Contact Form", value: 60, finished: false, finishDate: null}
                    ]},
                    {id: 3, name: "Client Meeting Prep", value: 60, deadline: null, finished: false, finishDate: null, subtasks: []}, // No deadline
                    {id: 4, name: "Research Competitors", value: 90, deadline: formatDate(twoWeeks), finished: false, finishDate: null, subtasks: []}
                ];
            }

            // --- UI Rendering ---

            // Combined rerender function
            function rerenderAll() {
                 renderTasks();
                 renderFinishedTasks();
                 updateChart();
            }

            function renderTasks() {
                taskList.innerHTML = ''; // Clear active tasks list
                const activeTasks = tasks.filter(task => !task.finished);

                if (activeTasks.length === 0) {
                    taskList.innerHTML = '<p class="text-muted" style="text-align: center;">No active tasks.</p>';
                    return;
                }

                activeTasks.forEach((task, index) => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    taskItem.dataset.id = task.id;
                    const colorInfo = getTaskColorInfo(task, index);

                    // Header: Color, Title, Actions
                    const itemHeader = document.createElement('div');
                    itemHeader.className = 'item-header';

                    const itemTitleRow = document.createElement('div');
                    itemTitleRow.className = 'item-title-row';
                    const colorIndicator = document.createElement('span');
                    colorIndicator.className = 'color-indicator';
                    colorIndicator.style.backgroundColor = colorInfo.finalColor;
                    const itemTitle = document.createElement('span');
                    itemTitle.className = 'item-title';
                    itemTitle.textContent = `${task.name} (${task.value} min)`;
                    itemTitleRow.appendChild(colorIndicator);
                    itemTitleRow.appendChild(itemTitle);

                    const itemActions = document.createElement('div');
                    itemActions.className = 'item-actions';
                    // Done Button
                     const doneButton = document.createElement('button');
                     doneButton.className = 'action-button done-button';
                     doneButton.innerHTML = '&#10003;'; // Checkmark
                     doneButton.title = "Mark Task as Done";
                     doneButton.onclick = (e) => { e.stopPropagation(); markAsDone(task.id, 'task'); };
                     // Edit Button
                    const editButton = document.createElement('button');
                    editButton.className = 'action-button edit-button';
                    editButton.innerHTML = '&#9998;'; // Pencil
                    editButton.title = "Edit Task";
                    editButton.onclick = (e) => { e.stopPropagation(); openEditTaskDialog(task); };
                    // Delete Button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'action-button delete-button';
                    deleteButton.innerHTML = '&#10005;'; // Cross
                    deleteButton.title = "Delete Task";
                    deleteButton.onclick = (e) => { e.stopPropagation(); if (confirm(`Delete task "${task.name}"?`)) deleteTask(task.id); };

                    itemActions.appendChild(doneButton);
                    itemActions.appendChild(editButton);
                    itemActions.appendChild(deleteButton);
                    itemHeader.appendChild(itemTitleRow);
                    itemHeader.appendChild(itemActions);
                    taskItem.appendChild(itemHeader);

                    // Meta Info: Deadline, Add Subtask Button
                    const taskMeta = document.createElement('div');
                    taskMeta.className = 'task-meta';
                    const deadlineSpan = document.createElement('span');
                    deadlineSpan.className = 'task-deadline';
                    if (task.deadline) {
                        deadlineSpan.textContent = `Due: ${task.deadline}`;
                        if (colorInfo.urgency === 'overdue') deadlineSpan.classList.add('text-danger');
                        else if (colorInfo.urgency === 'due_soon') deadlineSpan.classList.add('text-warning');
                    } else { deadlineSpan.textContent = 'No deadline'; deadlineSpan.classList.add('text-muted');}
                    const addSubtaskBtn = document.createElement('button');
                    addSubtaskBtn.className = 'add-subtask-list-btn';
                    addSubtaskBtn.textContent = 'Add Subtask +';
                    addSubtaskBtn.onclick = (e) => { e.stopPropagation(); openAddSubtaskDialog(task.id, task.name); };
                    taskMeta.appendChild(deadlineSpan);
                    taskMeta.appendChild(addSubtaskBtn);
                    taskItem.appendChild(taskMeta);

                    // Active Subtasks List
                    const activeSubtasks = task.subtasks.filter(st => !st.finished);
                    if (activeSubtasks.length > 0) {
                        const subtaskList = document.createElement('div');
                        subtaskList.className = 'subtask-list';
                        activeSubtasks.forEach(subtask => {
                            const subtaskItem = document.createElement('div');
                            subtaskItem.className = 'subtask-item';

                            const subtaskTitleRow = document.createElement('div');
                            subtaskTitleRow.className = 'subtask-title-row';
                            const subtaskColorIndicator = document.createElement('span');
                            subtaskColorIndicator.className = 'subtask-color-indicator';
                            subtaskColorIndicator.style.backgroundColor = varyColor(colorInfo.finalColor);
                            const subtaskTitle = document.createElement('span');
                            subtaskTitle.className = 'subtask-title';
                            subtaskTitle.textContent = `${subtask.name} (${subtask.value} min)`;
                            subtaskTitleRow.appendChild(subtaskColorIndicator);
                            subtaskTitleRow.appendChild(subtaskTitle);

                             // Subtask Actions (Done, Delete)
                            const subtaskActions = document.createElement('div');
                            subtaskActions.className = 'item-actions';
                             const subtaskDoneButton = document.createElement('button');
                             subtaskDoneButton.className = 'action-button done-button';
                             subtaskDoneButton.innerHTML = '&#10003;';
                             subtaskDoneButton.title = "Mark Subtask as Done";
                             subtaskDoneButton.style.padding = '2px 6px'; subtaskDoneButton.style.fontSize = '10px';
                             subtaskDoneButton.onclick = (e) => { e.stopPropagation(); markAsDone(subtask.id, 'subtask'); };

                            const subtaskDeleteButton = document.createElement('button');
                            subtaskDeleteButton.className = 'action-button delete-button';
                            subtaskDeleteButton.innerHTML = '&#10005;';
                            subtaskDeleteButton.title = 'Delete Subtask';
                            subtaskDeleteButton.style.padding = '2px 6px'; subtaskDeleteButton.style.fontSize = '10px';
                            subtaskDeleteButton.onclick = (e) => { e.stopPropagation(); if (confirm(`Delete subtask "${subtask.name}"?`)) deleteSubtask(task.id, subtask.id); };

                             subtaskActions.appendChild(subtaskDoneButton);
                            subtaskActions.appendChild(subtaskDeleteButton);
                            subtaskItem.appendChild(subtaskTitleRow);
                             subtaskItem.appendChild(subtaskActions);
                            subtaskList.appendChild(subtaskItem);
                        });
                        taskItem.appendChild(subtaskList);
                    }
                    taskList.appendChild(taskItem);
                });
            }

            // New function to render finished tasks
             function renderFinishedTasks() {
                 finishedList.innerHTML = '';
                 const sevenDaysAgo = new Date(TODAY.getTime() - 7 * 24 * 60 * 60 * 1000);
                 let recentCount = 0;

                 // Iterate backwards to easily check parent task color
                 for (let i = tasks.length - 1; i >= 0; i--) {
                      const task = tasks[i];
                      const originalIndex = i; // Index for color calculation

                      // Check finished subtasks first
                      if (task.subtasks && task.subtasks.length > 0) {
                           task.subtasks.forEach(subtask => {
                               if (subtask.finished && subtask.finishDate && new Date(subtask.finishDate) >= sevenDaysAgo) {
                                   recentCount++;
                                   const item = document.createElement('div');
                                   item.className = 'finished-item';
                                   const colorInfo = getTaskColorInfo(task, originalIndex); // Use parent task's index for color context

                                   item.innerHTML = `
                                        <div class="item-header">
                                             <div class="item-title-row">
                                                  <span class="color-indicator" style="background-color: ${varyColor(colorInfo.finalColor)}; opacity: 0.6;"></span>
                                                  <span class="item-title" style="text-decoration: line-through; color: #888;">${subtask.name} (Subtask)</span>
                                             </div>
                                        </div>
                                        <div class="finished-details">Finished: ${new Date(subtask.finishDate).toLocaleDateString()}</div>
                                   `;
                                   finishedList.appendChild(item);
                               }
                           });
                      }

                      // Check finished tasks
                      if (task.finished && task.finishDate && new Date(task.finishDate) >= sevenDaysAgo) {
                          recentCount++;
                          const item = document.createElement('div');
                          item.className = 'finished-item';
                          const colorInfo = getTaskColorInfo(task, originalIndex);

                           item.innerHTML = `
                                <div class="item-header">
                                     <div class="item-title-row">
                                          <span class="color-indicator" style="background-color: ${colorInfo.finalColor}; opacity: 0.6;"></span>
                                          <span class="item-title" style="text-decoration: line-through; color: #888;">${task.name}</span>
                                     </div>
                                </div>
                                <div class="finished-details">Finished: ${new Date(task.finishDate).toLocaleDateString()}</div>
                           `;
                          finishedList.appendChild(item);
                      }
                 }


                 if (recentCount === 0) {
                     finishedList.innerHTML = '<p class="text-muted" style="text-align: center;">No tasks finished in the last 7 days.</p>';
                 }
             }


            // --- Chart Initialization and Update ---
            function initChart() {
                 const ctx = document.getElementById('mainChart').getContext('2d');
                 if (mainChart) { mainChart.destroy(); }
                 mainChart = new Chart(ctx, {
                     type: 'doughnut',
                     data: { labels: [], datasets: [ { data: [], backgroundColor: [], hoverOffset: 10, borderWidth: 2, borderColor: '#fff' }, { data: [], backgroundColor: [], hoverOffset: 10, borderWidth: 2, borderColor: '#fff' } ], preparedData: { tasks: [], subtasks: [] } },
                     options: {
                         responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 360, cutout: '30%', animation: { animateScale: true, animateRotate: true },
                         plugins: {
                             legend: { display: false },
                             tooltip: {
                                  backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { size: 14 }, bodyFont: { size: 12 }, padding: 10, cornerRadius: 4, displayColors: false, // Hide color box in tooltip
                                 callbacks: {
                                      label: function(context) {
                                          let label = ''; const data = context.chart.config.data.preparedData; const dsIdx = context.datasetIndex; const idx = context.dataIndex;
                                           if(dsIdx === 0 && data.tasks[idx]) { label = `${data.tasks[idx].name}: ${data.tasks[idx].value} min`; if(data.tasks[idx].deadline) label += ` (Due: ${data.tasks[idx].deadline})`; }
                                           else if (dsIdx === 1 && data.subtasks[idx]) { label = `${data.subtasks[idx].name}: ${data.subtasks[idx].value} min`; }
                                           else { label = `Value: ${context.parsed}`; }
                                          return label;
                                      }
                                 }
                             }
                         },
                         onClick: (clickEvent) => handleChartClick(clickEvent, mainChart)
                     }
                 });
             }

             function updateChart() {
                 if (!mainChart) { initChart(); }

                  // Filter only active tasks/subtasks for the chart
                  const activeTasks = tasks.filter(t => !t.finished);
                  const preparedTasks = [];
                  const preparedSubtasks = [];
                  const taskColors = [];
                  const subtaskValues = [];
                  const subtaskColors = [];

                  activeTasks.forEach((task, index) => {
                       const colorInfo = getTaskColorInfo(task, index);
                       preparedTasks.push({ id: task.id, name: task.name, value: task.value, deadline: task.deadline, color: colorInfo.finalColor });
                       taskColors.push(colorInfo.finalColor);

                       task.subtasks.filter(st => !st.finished).forEach((subtask) => { // Only active subtasks
                           preparedSubtasks.push({ id: subtask.id, parentId: task.id, parentIndex: index, name: subtask.name, value: subtask.value });
                           subtaskValues.push(subtask.value);
                           subtaskColors.push(varyColor(colorInfo.finalColor, 25)); // Slightly more variation
                       });
                  });

                  mainChart.config.data.preparedData = { tasks: preparedTasks, subtasks: preparedSubtasks };
                  mainChart.config.data.datasets[0].data = preparedTasks.map(t => t.value);
                  mainChart.config.data.datasets[0].backgroundColor = taskColors;
                  mainChart.config.data.datasets[1].data = subtaskValues;
                  mainChart.config.data.datasets[1].backgroundColor = subtaskColors;
                  mainChart.update();
                  console.log("Chart Updated with active tasks/subtasks.");
             }

            // --- Modal Handling ---
            function setupDialog(dialogElement, openTriggerElement, formElement, submitCallback) {
                 if (openTriggerElement) { // Not all dialogs might have an external open trigger (like edit)
                     openTriggerElement.addEventListener('click', () => dialogElement.showModal());
                 }

                 // Handle form submission
                 formElement.addEventListener('submit', (e) => {
                     // Check which button was clicked if using value attribute
                     const submitterValue = e.submitter ? e.submitter.getAttribute('value') : null;
                      if (submitterValue !== 'cancel') { // Process if not cancelled
                         submitCallback(new FormData(formElement)); // Pass form data
                         // Dialog closes automatically due to method="dialog" on successful submit
                      }
                      // else: Cancel button pressed, dialog closes automatically
                 });

                 // Optional: Close dialog if cancel button without value is clicked
                 const cancelButton = formElement.querySelector('button[value="cancel"]');
                 if (cancelButton) {
                      cancelButton.addEventListener('click', () => dialogElement.close());
                 }
            }

             // Setup Add Task Dialog
             setupDialog(addTaskDialog, showAddTaskModalBtn, addTaskForm, (formData) => {
                 const name = taskNameInput.value.trim(); // Get value directly for safety
                 const value = parseInt(taskValueInput.value);
                 const deadline = taskDeadlineInput.value || null;
                 if (name && value > 0) { addTask(name, value, deadline); }
                 else { alert('Invalid task details.'); }
             });

             // Setup Add Subtask Dialog (opened via task list buttons)
             setupDialog(addSubtaskDialog, null, addSubtaskForm, (formData) => {
                 const parentId = parseInt(parentTaskIdInput.value);
                 const name = subtaskNameInput.value.trim();
                 const value = parseInt(subtaskValueInput.value);
                 if (parentId && name && value > 0) {
                     const success = addSubtask(parentId, name, value);
                     if (!success && addSubtaskDialog.open) {
                          // Re-open dialog if addSubtask failed (e.g., value too high)
                          // This prevents auto-close via method="dialog" if validation fails
                          // alert handled inside addSubtask
                           addSubtaskDialog.showModal(); // Need to explicitly reopen
                      }
                      // else: Success or parent not found, let it close or stay closed
                 } else { alert('Invalid subtask details.'); addSubtaskDialog.showModal(); } // Reopen on basic validation fail
             });

              // Setup Edit Task Dialog (opened via task list buttons)
             setupDialog(editTaskDialog, null, editTaskForm, (formData) => {
                  const id = parseInt(editTaskIdInput.value);
                  const name = editTaskNameInput.value.trim();
                  const value = parseInt(editTaskValueInput.value);
                  const deadline = editTaskDeadlineInput.value || null;
                   if (id && name && value > 0) {
                       const success = updateTask(id, name, value, deadline);
                        if (!success && editTaskDialog.open) { editTaskDialog.showModal(); } // Reopen on validation fail
                  } else { alert('Invalid task details.'); editTaskDialog.showModal(); }
             });

             // Functions to open dialogs (called from list render)
             window.openAddSubtaskDialog = (taskId, taskName) => { // Expose to global scope for inline onclick
                addSubtaskForm.reset();
                parentTaskIdInput.value = taskId;
                addSubtaskTitle.textContent = `Add Subtask to "${taskName}"`;
                addSubtaskDialog.showModal();
             };
             window.openEditTaskDialog = (task) => {
                 editTaskForm.reset();
                 editTaskIdInput.value = task.id;
                 editTaskNameInput.value = task.name;
                 editTaskValueInput.value = task.value;
                 editTaskDeadlineInput.value = task.deadline || '';
                 editTaskDialog.showModal();
             };


            // --- Initialize ---
            loadTasks(); // Load data, render lists, init & update chart

        }); // End DOMContentLoaded
    </script>

</body>
</html>
Projects I have worked on
